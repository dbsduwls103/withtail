<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="shop">
	<!-- 현재 카테고리 -->
	<select id="readCategory" resultType="com.sp.withtail.shop.Product" parameterType="long">
		SELECT dept, ctNum, ctName
		FROM category
		WHERE ctNum = #{ctNum}
	</select>
	
	<!-- 동일 레벨 카테고리 -->
	<select id="listCategory" resultType="com.sp.withtail.shop.Product">
		SELECT dept, ctNum, ctName, parentCt
		FROM category
		WHERE parentCt 
	</select>
	
	<!-- 바로 하위 카테고리 리스트 -->
	<select id="listSubCategory" resultType="com.sp.withtail.shop.Product" parameterType="long">
		SELECT dept, ctNum, ctName, parentCt
		FROM category
    	WHERE parentCt = #{ctNum}
    	ORDER BY ctNum
	</select>
	
	<select id="readSubCategory" resultType="com.sp.withtail.shop.Product" parameterType="long">
		SELECT ctNum, ctName, parentCt
		FROM category
		WHERE ctNum = #{ctNum}
	</select>
	
	<!-- 상품 개수 -->
	<select id="dataCount" parameterType="map" resultType="Integer">  
		SELECT NVL(COUNT(DISTINCT i.itemName), 0)
		FROM item i
		JOIN (
	        SELECT ctName, ctNum
	        FROM category
	        START WITH parentCT = #{ctNum} OR ctNum = #{ctNum}
	        CONNECT BY PRIOR ctNum = parentCT
	    ) cc ON cc.ctNum = i.ctNum
		WHERE showNotice = 0
	</select>
	
	<!-- 상품 리스트 -->
	<select id="listProd" parameterType="map" resultType="com.sp.withtail.shop.Product">
		SELECT DISTINCT i.itemNum, i.itemName, i.discount, i.mainImage, i.price, 
			i.price - (i.price * (i.discount/100)) dcPrice,
            NVL(orderCount, 0) orderCount,
            NVL(rvCount, 0) rvCount
	    FROM item i
	    JOIN (
	        SELECT ctName, ctNum
	        FROM category
	        START WITH parentCT = #{ctNum} OR ctNum = #{ctNum}
	        CONNECT BY PRIOR ctNum = parentCT
	    ) c ON c.ctNum = i.ctNum
        LEFT OUTER JOIN (
			SELECT itemNum, COUNT(*) orderCount
			FROM orderDetail
			GROUP BY itemNum
		) od ON i.itemNum = od.itemNum
        LEFT OUTER JOIN (
			SELECT itemNum, COUNT(*) rvCount
			FROM review
			GROUP BY itemNum
		) rv ON i.itemNum = rv.itemNum
	    LEFT OUTER JOIN itemJjim ij ON i.itemNum = ij.itemNum
	    WHERE showNotice = 0
	    ORDER BY i.itemNum DESC
		OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
	</select>
	 
	<!-- 글 보기 -->
	<!--
	<select id="readProd" parameterType="Long" resultType="com.sp.withtail.shop.Product">
		SELECT i.num, i.categoryNum, i.name, i.discount, i.content, i.madeby
		FROM item i
		JOIN itemPhoto ip ON
		JOIN food f ON
		JOIN option1 op1 ON
		JOIN option2 op2 ON
		JOIN category c ON
	</select>
	-->

</mapper>